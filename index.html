<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de CorrespondÃªncias</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2.5rem;
        }
        
        .header p {
            font-size: 1rem;
            opacity: 0.8;
        }
        
        .logo-pequeno {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 70px; 
            height: auto;
            border-radius: 8px;
        }

        .navigation {
            display: flex;
            gap: 2rem;
            background: white;
            padding: 0 2rem;
            border-bottom: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .nav-item {
            padding: 1rem 0;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .nav-item:hover, .nav-item.active {
            color: #1a73e8;
            border-bottom-color: #1a73e8;
        }

        .hidden {
            display: none;
        }

        .content-section {
            padding: 2rem 0;
        }

        .form-container, .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #333;
        }

        input, select, textarea {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            margin-top: 2rem;
        }

        .btn {
            background: #1a73e8;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-primary { background: #1a73e8; }
        .btn-primary:hover { background: #1557b0; }

        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }

        .btn-secondary { background: #f8f9fa; color: #666; border: 1px solid #ddd; }
        .btn-secondary:hover { background: #e9ecef; }

        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f8f9fa;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #666;
            border-bottom: 1px solid #e9ecef;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        .table tbody tr:hover {
            background: #f8f9fa;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendente {
            background-color: #fcf8e3;
            color: #8a6d3b;
            border: 1px solid #faebcc;
        }

        .status-entregue {
            background-color: #dff0d8;
            color: #3c763d;
            border: 1px solid #d6e9c6;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            padding-top: 50px;
            overflow: auto;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #666;
        }

    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>ðŸ“¬ Sistema de CorrespondÃªncias</h1>
            <p>Gerencie suas correspondÃªncias de forma eficiente</p>
        </div>
        <img src="logo_condominio.jpg" alt="Logo do CondomÃ­nio" class="logo-pequeno">
    </div>

    <nav class="navigation">
        <a href="#" class="nav-item active" onclick="showSection('correspondencias')">
            <i class="fas fa-envelope"></i>
            CorrespondÃªncias Pendentes
        </a>
        <a href="#" class="nav-item" onclick="showSection('moradores')">
            <i class="fas fa-users"></i>
            Moradores
        </a>
        <a href="#" class="nav-item" onclick="showSection('correspondencias-entregues')">
            <i class="fas fa-check"></i>
            CorrespondÃªncias Entregues
        </a>
    </nav>

    <div class="container">
        <div id="correspondencias-section" class="content-section">
            <div class="form-container">
                <h2 class="section-title">
                    <i class="fas fa-envelope"></i>
                    Registrar Nova CorrespondÃªncia
                </h2>
                <form id="formCorrespondencia">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="blocoCorrespondencia">Bloco *</label>
                            <select id="blocoCorrespondencia" required onchange="popularApartamentosEMoradores()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="apartamentoCorrespondencia">Apartamento *</label>
                            <select id="apartamentoCorrespondencia" required onchange="popularMoradores()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="moradorCorrespondencia">Morador DestinatÃ¡rio *</label>
                            <select id="moradorCorrespondencia" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tipo">Tipo de CorrespondÃªncia *</label>
                            <select id="tipo" name="tipo" required>
                                <option value="">Selecione o tipo</option>
                                <option value="carta">Carta</option>
                                <option value="encomenda">Encomenda</option>
                                <option value="sedex">Sedex</option>
                                <option value="ar">AR (Aviso de Recebimento)</option>
                                <option value="telegrama">Telegrama</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label for="descricao">DescriÃ§Ã£o do Produto/CorrespondÃªncia *</label>
                            <textarea id="descricao" placeholder="Ex: Encomenda dos Correios - Caixa mÃ©dia, CorrespondÃªncia bancÃ¡ria - Envelope..." maxlength="500" required></textarea>
                            <small style="color: #666; margin-top: 0.5rem; display: block;">
                                <span id="contadorCaracteres">0/500 caracteres</span>
                            </small>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="limparFormulario('formCorrespondencia')">
                            <i class="fas fa-broom"></i> Limpar FormulÃ¡rio
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Registrar e Notificar
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="section-title"><i class="fas fa-list"></i> CorrespondÃªncias Pendentes</h2>
                    <div style="display: flex; gap: 1rem;">
                         <button class="btn btn-primary" onclick="notificarAtrasadas()">
                            <i class="fas fa-bell"></i>
                            Notificar Atrasadas
                        </button>
                    </div>
                </div>
                <div class="filters">
                    <div class="form-group">
                        <label>Buscar Morador</label>
                        <input type="text" id="filtroMoradorPendente" placeholder="Nome do morador..." onkeyup="filtrarCorrespondenciasPendentes()">
                    </div>
                    <div class="form-group">
                        <label>Bloco</label>
                        <select id="filtroBlocoPendente" onchange="filtrarCorrespondenciasPendentes()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Apartamento</label>
                        <select id="filtroAptoPendente" onchange="filtrarCorrespondenciasPendentes()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group" style="align-self: end;">
                        <button class="btn btn-secondary" onclick="limparFiltrosPendentes()">
                            <i class="fas fa-eraser"></i> Limpar Filtros
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>DATA</th>
                                <th>HORA</th>
                                <th>MORADOR</th>
                                <th>UNIDADE</th>
                                <th>DESCRIÃ‡ÃƒO</th>
                                <th>STATUS</th>
                                <th>AÃ‡Ã•ES</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCorrespondenciasPendentes">
                            <tr>
                                <td colspan="7" class="no-data">Nenhuma correspondÃªncia pendente.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="moradores-section" class="content-section hidden">
            <div class="form-container">
                <h2 class="section-title">
                    <i class="fas fa-user-plus"></i>
                    Cadastrar Novo Morador
                </h2>
                <form id="formMorador">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nomeMorador">Nome Completo *</label>
                            <input type="text" id="nomeMorador" placeholder="Digite o nome completo" required>
                        </div>
                        <div class="form-group">
                            <label for="telefoneMorador">Telefone (WhatsApp) *</label>
                            <input type="tel" id="telefoneMorador" placeholder="(11) 99999-9999" required>
                        </div>
                        <div class="form-group">
                            <label for="blocoMorador">Bloco *</label>
                            <select id="blocoMorador" required onchange="popularApartamentosMorador()">
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="apartamentoMorador">Apartamento *</label>
                            <select id="apartamentoMorador" required>
                                <option value="">Selecione...</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="limparFormulario('formMorador')">
                            <i class="fas fa-broom"></i> Limpar FormulÃ¡rio
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Cadastrar Morador
                        </button>
                    </div>
                </form>
            </div>
            
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="section-title">
                        <i class="fas fa-users"></i>
                        Moradores Cadastrados
                    </h2>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <input type="text" id="buscaMorador" placeholder="Buscar por nome..." style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 6px;" onkeyup="filtrarMoradores()">
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>NOME</th>
                                <th>UNIDADE</th>
                                <th>TELEFONE</th>
                                <th>AÃ‡Ã•ES</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaMoradores">
                            <tr>
                                <td colspan="4" class="no-data">Nenhum morador cadastrado ainda.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="correspondencias-entregues-section" class="content-section hidden">
            <div class="table-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="section-title">
                        <i class="fas fa-check"></i>
                        CorrespondÃªncias Entregues
                    </h2>
                     <button class="btn btn-success" onclick="exportarCorrespondenciasEntregues()">
                        <i class="fas fa-file-excel"></i> Exportar para Excel
                    </button>
                </div>
                <div class="filters">
                    <div class="form-group">
                        <label>Buscar Morador</label>
                        <input type="text" id="filtroMoradorEntregue" placeholder="Nome do morador..." onkeyup="filtrarCorrespondenciasEntregues()">
                    </div>
                    <div class="form-group">
                        <label>Bloco</label>
                        <select id="filtroBlocoEntregue" onchange="filtrarCorrespondenciasEntregues()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Apartamento</label>
                        <select id="filtroAptoEntregue" onchange="filtrarCorrespondenciasEntregues()">
                            <option value="">Todos</option>
                        </select>
                    </div>
                     <div class="form-group" style="align-self: end;">
                        <button class="btn btn-secondary" onclick="limparFiltrosEntregues()">
                            <i class="fas fa-eraser"></i> Limpar Filtros
                        </button>
                    </div>
                </div>
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>DATA ENTREGA</th>
                                <th>MORADOR</th>
                                <th>UNIDADE</th>
                                <th>DESCRIÃ‡ÃƒO</th>
                                <th>RETIRADO POR</th>
                                <th>AÃ‡Ã•ES</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaCorrespondenciasEntregues">
                            <tr>
                                <td colspan="6" class="no-data">Nenhuma correspondÃªncia entregue.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="modalEditarMorador" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Morador</h3>
                <button class="close" onclick="fecharModal('modalEditarMorador')">&times;</button>
            </div>
            <form id="formEditarMorador">
                <input type="hidden" id="editMoradorId">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nome Completo</label>
                        <input type="text" id="editNome" required>
                    </div>
                    <div class="form-group">
                        <label>Telefone</label>
                        <input type="tel" id="editTelefone" required>
                    </div>
                    <div class="form-group">
                        <label>Bloco</label>
                        <select id="editBloco" required onchange="popularApartamentosEdicao()">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Apartamento</label>
                        <select id="editApartamento" required>
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modalEditarMorador')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Salvar AlteraÃ§Ãµes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalEntrega" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Marcar como Entregue</h3>
                <button class="close" onclick="fecharModal('modalEntrega')">&times;</button>
            </div>
            <form id="formEntrega">
                <input type="hidden" id="entregaCorrespondenciaId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="entreguePara">Entregue para (Nome completo) *</label>
                        <input type="text" id="entreguePara" placeholder="Digite o nome de quem retirou a correspondÃªncia" required>
                    </div>
                    <div class="form-group">
                        <label for="dataEntrega">Data da Entrega</label>
                        <input type="date" id="dataEntrega" required>
                    </div>
                    <div class="form-group">
                        <label for="horaEntrega">Hora da Entrega</label>
                        <input type="time" id="horaEntrega" required>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label for="observacoesEntrega">ObservaÃ§Ãµes da Entrega</label>
                    <textarea id="observacoesEntrega" placeholder="InformaÃ§Ãµes adicionais sobre a entrega (opcional)" rows="3"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="fecharModal('modalEntrega')">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Confirmar Entrega
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        const db = {
            moradores: [],
            correspondencias: [],

            init() {
                this.moradores = JSON.parse(localStorage.getItem('moradores')) || [];
                this.correspondencias = JSON.parse(localStorage.getItem('correspondencias')) || [];
            },

            salvar() {
                localStorage.setItem('moradores', JSON.stringify(this.moradores));
                localStorage.setItem('correspondencias', JSON.stringify(this.correspondencias));
            },

            addMorador(morador) {
                const novoMorador = {
                    id: Date.now().toString(),
                    ...morador
                };
                this.moradores.push(novoMorador);
                this.salvar();
                return novoMorador;
            },

            updateMorador(id, dados) {
                const index = this.moradores.findIndex(m => m.id === id);
                if (index !== -1) {
                    this.moradores[index] = { ...this.moradores[index], ...dados };
                    this.salvar();
                    return this.moradores[index];
                }
                return null;
            },

            deleteMorador(id) {
                this.moradores = this.moradores.filter(m => m.id !== id);
                this.salvar();
            },

            addCorrespondencia(correspondencia) {
                const nova = {
                    ...correspondencia,
                    id: Date.now().toString(),
                    dataCadastro: new Date().toISOString(),
                    status: 'Pendente'
                };
                this.correspondencias.push(nova);
                this.salvar();
                return nova;
            },

            marcarComoEntregue(id, dadosEntrega) {
                const index = this.correspondencias.findIndex(c => c.id === id);
                if (index !== -1) {
                    this.correspondencias[index] = {
                        ...this.correspondencias[index],
                        status: 'Entregue',
                        ...dadosEntrega
                    };
                    this.salvar();
                    return this.correspondencias[index];
                }
                return null;
            }
        };

        const forms = {
            formCorrespondencia: document.getElementById('formCorrespondencia'),
            formMorador: document.getElementById('formMorador'),
            formEditarMorador: document.getElementById('formEditarMorador'),
            formEntrega: document.getElementById('formEntrega')
        };

        const tables = {
            tabelaCorrespondenciasPendentes: document.getElementById('tabelaCorrespondenciasPendentes'),
            tabelaMoradores: document.getElementById('tabelaMoradores'),
            tabelaCorrespondenciasEntregues: document.getElementById('tabelaCorrespondenciasEntregues')
        };

        const inputs = {
            blocoCorrespondencia: document.getElementById('blocoCorrespondencia'),
            apartamentoCorrespondencia: document.getElementById('apartamentoCorrespondencia'),
            moradorCorrespondencia: document.getElementById('moradorCorrespondencia'),
            descricao: document.getElementById('descricao'),
            nomeMorador: document.getElementById('nomeMorador'),
            telefoneMorador: document.getElementById('telefoneMorador'),
            blocoMorador: document.getElementById('blocoMorador'),
            apartamentoMorador: document.getElementById('apartamentoMorador'),
            filtroBlocoPendente: document.getElementById('filtroBlocoPendente'),
            filtroAptoPendente: document.getElementById('filtroAptoPendente'),
            filtroMoradorPendente: document.getElementById('filtroMoradorPendente'),
            filtroBlocoEntregue: document.getElementById('filtroBlocoEntregue'),
            filtroAptoEntregue: document.getElementById('filtroAptoEntregue'),
            filtroMoradorEntregue: document.getElementById('filtroMoradorEntregue'),
            editMoradorId: document.getElementById('editMoradorId'),
            editNome: document.getElementById('editNome'),
            editTelefone: document.getElementById('editTelefone'),
            editBloco: document.getElementById('editBloco'),
            editApartamento: document.getElementById('editApartamento'),
            entregaCorrespondenciaId: document.getElementById('entregaCorrespondenciaId'),
            entreguePara: document.getElementById('entreguePara'),
            dataEntrega: document.getElementById('dataEntrega'),
            horaEntrega: document.getElementById('horaEntrega'),
            observacoesEntrega: document.getElementById('observacoesEntrega')
        };

        const sections = {
            correspondencias: document.getElementById('correspondencias-section'),
            moradores: document.getElementById('moradores-section'),
            entregues: document.getElementById('correspondencias-entregues-section')
        };

        const modals = {
            editarMorador: document.getElementById('modalEditarMorador'),
            entrega: document.getElementById('modalEntrega')
        };

        const blocos = ['01', '02', '03', '04', '05', '06'];
        const aptosPorBloco = {
            '01': ['101', '102', '103', '104', '105', '106', '107', '108'],
            '02': ['201', '202', '203', '204', '205', '206', '207', '208'],
            '03': ['301', '302', '303', '304', '305', '306', '307', '308'],
            '04': ['401', '402', '403', '404', '405', '406', '407', '408'],
            '05': ['501', '502', '503', '504', '505', '506', '507', '508'],
            '06': ['601', '602', '603', '604', '605', '606', '607', '608'],
        };

        function init() {
            db.init();
            renderizarTabelas();
            popularSelects();
        }

        function popularSelects() {
            // Popula os selects de Bloco
            const selectsBloco = [inputs.blocoCorrespondencia, inputs.blocoMorador, inputs.filtroBlocoPendente, inputs.filtroBlocoEntregue, inputs.editBloco];
            selectsBloco.forEach(select => {
                select.innerHTML = '<option value="">Selecione...</option>';
                blocos.forEach(bloco => {
                    const option = document.createElement('option');
                    option.value = bloco;
                    option.textContent = `Bloco ${bloco}`;
                    select.appendChild(option);
                });
            });
        }

        function popularApartamentosEMoradores() {
            const bloco = inputs.blocoCorrespondencia.value;
            popularApartamentos(inputs.apartamentoCorrespondencia, bloco);
            popularMoradores();
        }
        
        function popularApartamentosMorador() {
             const bloco = inputs.blocoMorador.value;
             popularApartamentos(inputs.apartamentoMorador, bloco);
        }
        
        function popularApartamentosEdicao() {
            const bloco = inputs.editBloco.value;
            popularApartamentos(inputs.editApartamento, bloco);
        }

        function popularApartamentos(selectElement, bloco) {
            selectElement.innerHTML = '<option value="">Selecione...</option>';
            if (bloco && aptosPorBloco[bloco]) {
                aptosPorBloco[bloco].forEach(apto => {
                    const option = document.createElement('option');
                    option.value = apto;
                    option.textContent = `Apartamento ${apto}`;
                    selectElement.appendChild(option);
                });
            }
        }

        function popularMoradores() {
            const bloco = inputs.blocoCorrespondencia.value;
            const apto = inputs.apartamentoCorrespondencia.value;
            
            const moradorSelect = inputs.moradorCorrespondencia;
            moradorSelect.innerHTML = '<option value="">Selecione...</option>';

            if (bloco && apto) {
                const moradoresFiltrados = db.moradores.filter(m => m.bloco === bloco && m.apartamento === apto);
                moradoresFiltrados.forEach(morador => {
                    const option = document.createElement('option');
                    option.value = morador.nome;
                    option.textContent = morador.nome;
                    moradorSelect.appendChild(option);
                });
            }
        }

        function showSection(sectionId) {
            for (const key in sections) {
                sections[key].classList.add('hidden');
                document.querySelector(`[onclick="showSection('${key}')"]`).classList.remove('active');
            }
            sections[sectionId].classList.remove('hidden');
            document.querySelector(`[onclick="showSection('${sectionId}')"]`).classList.add('active');
            renderizarTabelas();
        }

        function renderizarTabelas() {
            renderizarTabelaCorrespondenciasPendentes();
            renderizarTabelaMoradores();
            renderizarTabelaCorrespondenciasEntregues();
        }

        function renderizarTabelaCorrespondenciasPendentes(filtro = {}) {
            const correspondenciasPendentes = db.correspondencias.filter(c => c.status === 'Pendente');
            const filtradas = correspondenciasPendentes.filter(c => {
                const moradorMatch = !filtro.morador || c.morador.toLowerCase().includes(filtro.morador.toLowerCase());
                const blocoMatch = !filtro.bloco || c.bloco === filtro.bloco;
                const aptoMatch = !filtro.apto || c.apto === filtro.apto;
                return moradorMatch && blocoMatch && aptoMatch;
            });

            if (filtradas.length === 0) {
                tables.tabelaCorrespondenciasPendentes.innerHTML = `<tr><td colspan="7" class="no-data">Nenhuma correspondÃªncia pendente.</td></tr>`;
                return;
            }

            tables.tabelaCorrespondenciasPendentes.innerHTML = filtradas.map(c => `
                <tr>
                    <td>${new Date(c.dataCadastro).toLocaleDateString('pt-BR')}</td>
                    <td>${new Date(c.dataCadastro).toLocaleTimeString('pt-BR').substring(0, 5)}</td>
                    <td>${c.morador}</td>
                    <td>Bloco ${c.bloco}, Apto ${c.apto}</td>
                    <td>${c.descricao}</td>
                    <td><span class="status-badge status-pendente">${c.status}</span></td>
                    <td>
                        <button class="btn btn-success" onclick="abrirModalEntrega('${c.id}')"><i class="fas fa-check"></i></button>
                    </td>
                </tr>
            `).join('');
        }

        function renderizarTabelaCorrespondenciasEntregues(filtro = {}) {
            const correspondenciasEntregues = db.correspondencias.filter(c => c.status === 'Entregue');
            const filtradas = correspondenciasEntregues.filter(c => {
                const moradorMatch = !filtro.morador || c.morador.toLowerCase().includes(filtro.morador.toLowerCase());
                const blocoMatch = !filtro.bloco || c.bloco === filtro.bloco;
                const aptoMatch = !filtro.apto || c.apto === filtro.apto;
                return moradorMatch && blocoMatch && aptoMatch;
            });
            
            if (filtradas.length === 0) {
                tables.tabelaCorrespondenciasEntregues.innerHTML = `<tr><td colspan="6" class="no-data">Nenhuma correspondÃªncia entregue.</td></tr>`;
                return;
            }

            tables.tabelaCorrespondenciasEntregues.innerHTML = filtradas.map(c => `
                <tr>
                    <td>${new Date(c.dataEntrega).toLocaleDateString('pt-BR')}</td>
                    <td>${c.morador}</td>
                    <td>Bloco ${c.bloco}, Apto ${c.apto}</td>
                    <td>${c.descricao}</td>
                    <td>${c.entreguePara}</td>
                    <td><button class="btn btn-danger" onclick="excluirCorrespondencia('${c.id}')"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function renderizarTabelaMoradores(filtro = '') {
            const filtrados = db.moradores.filter(m => m.nome.toLowerCase().includes(filtro.toLowerCase()));
            
            if (filtrados.length === 0) {
                tables.tabelaMoradores.innerHTML = `<tr><td colspan="4" class="no-data">Nenhum morador cadastrado ainda.</td></tr>`;
                return;
            }

            tables.tabelaMoradores.innerHTML = filtrados.map(m => `
                <tr>
                    <td>${m.nome}</td>
                    <td>Bloco ${m.bloco}, Apto ${m.apartamento}</td>
                    <td>${m.telefone}</td>
                    <td>
                        <button class="btn btn-warning" onclick="abrirModalEditarMorador('${m.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-danger" onclick="excluirMorador('${m.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        }
        
        function formatarNome(nome) {
            return nome.toLowerCase().split(' ').map(s => s.charAt(0).toUpperCase() + s.substring(1)).join(' ');
        }
        
        // Event Listeners dos formulÃ¡rios
        forms.formCorrespondencia.addEventListener('submit', (e) => {
            e.preventDefault();
            const correspondencia = {
                bloco: inputs.blocoCorrespondencia.value,
                apto: inputs.apartamentoCorrespondencia.value,
                morador: inputs.moradorCorrespondencia.value,
                tipo: inputs.tipo.value,
                descricao: inputs.descricao.value
            };
            db.addCorrespondencia(correspondencia);
            alert('CorrespondÃªncia registrada com sucesso! A notificaÃ§Ã£o foi enviada.');
            forms.formCorrespondencia.reset();
            popularApartamentosEMoradores();
            renderizarTabelas();
        });

        forms.formMorador.addEventListener('submit', (e) => {
            e.preventDefault();
            const morador = {
                nome: formatarNome(inputs.nomeMorador.value),
                telefone: inputs.telefoneMorador.value,
                bloco: inputs.blocoMorador.value,
                apartamento: inputs.apartamentoMorador.value
            };
            db.addMorador(morador);
            alert('Morador cadastrado com sucesso!');
            forms.formMorador.reset();
            renderizarTabelas();
            popularSelects();
        });
        
        forms.formEditarMorador.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = inputs.editMoradorId.value;
            const dados = {
                nome: formatarNome(inputs.editNome.value),
                telefone: inputs.editTelefone.value,
                bloco: inputs.editBloco.value,
                apartamento: inputs.editApartamento.value
            };
            db.updateMorador(id, dados);
            alert('Dados do morador atualizados com sucesso!');
            fecharModal('modalEditarMorador');
            renderizarTabelas();
        });

        forms.formEntrega.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = inputs.entregaCorrespondenciaId.value;
            const dadosEntrega = {
                entreguePara: formatarNome(inputs.entreguePara.value),
                dataEntrega: inputs.dataEntrega.value,
                horaEntrega: inputs.horaEntrega.value,
                observacoesEntrega: inputs.observacoesEntrega.value
            };
            db.marcarComoEntregue(id, dadosEntrega);
            alert('CorrespondÃªncia marcada como entregue!');
            fecharModal('modalEntrega');
            renderizarTabelas();
        });

        function abrirModalEditarMorador(id) {
            const morador = db.moradores.find(m => m.id === id);
            if (morador) {
                inputs.editMoradorId.value = morador.id;
                inputs.editNome.value = morador.nome;
                inputs.editTelefone.value = morador.telefone;
                
                popularApartamentosEdicao(); // Popula os apartamentos antes de definir o valor
                inputs.editBloco.value = morador.bloco;
                inputs.editApartamento.value = morador.apartamento;
                
                modals.editarMorador.style.display = 'block';
            }
        }
        
        function abrirModalEntrega(id) {
            const correspondencia = db.correspondencias.find(c => c.id === id);
            if (correspondencia) {
                inputs.entregaCorrespondenciaId.value = correspondencia.id;
                modals.entrega.style.display = 'block';
            }
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function excluirMorador(id) {
            if (confirm('Tem certeza que deseja excluir este morador?')) {
                db.deleteMorador(id);
                renderizarTabelas();
            }
        }
        
        function excluirCorrespondencia(id) {
            if (confirm('Tem certeza que deseja excluir esta correspondÃªncia do histÃ³rico?')) {
                db.correspondencias = db.correspondencias.filter(c => c.id !== id);
                db.salvar();
                renderizarTabelas();
            }
        }

        function limparFormulario(formId) {
            document.getElementById(formId).reset();
        }

        function filtrarCorrespondenciasPendentes() {
            const filtro = {
                morador: inputs.filtroMoradorPendente.value,
                bloco: inputs.filtroBlocoPendente.value,
                apto: inputs.filtroAptoPendente.value
            };
            renderizarTabelaCorrespondenciasPendentes(filtro);
        }
        
        function limparFiltrosPendentes() {
            inputs.filtroMoradorPendente.value = '';
            inputs.filtroBlocoPendente.value = '';
            inputs.filtroAptoPendente.value = '';
            renderizarTabelaCorrespondenciasPendentes({});
        }

        function filtrarCorrespondenciasEntregues() {
            const filtro = {
                morador: inputs.filtroMoradorEntregue.value,
                bloco: inputs.filtroBlocoEntregue.value,
                apto: inputs.filtroAptoEntregue.value
            };
            renderizarTabelaCorrespondenciasEntregues(filtro);
        }
        
        function limparFiltrosEntregues() {
            inputs.filtroMoradorEntregue.value = '';
            inputs.filtroBlocoEntregue.value = '';
            inputs.filtroAptoEntregue.value = '';
            renderizarTabelaCorrespondenciasEntregues({});
        }

        function filtrarMoradores() {
            const busca = inputs.buscaMorador.value;
            renderizarTabelaMoradores(busca);
        }

        function exportarCorrespondenciasEntregues() {
            const correspondenciasEntregues = db.correspondencias.filter(c => c.status === 'Entregue');
            if (correspondenciasEntregues.length === 0) {
                alert('NÃ£o hÃ¡ correspondÃªncias entregues para exportar.');
                return;
            }

            const cabecalho = "Data,Bloco,Apartamento,Morador,DescriÃ§Ã£o da Encomenda,Retirado Por\n";
            const csvContent = correspondenciasEntregues.map(item => {
                const data = new Date(item.dataEntrega).toLocaleDateString('pt-BR');
                const bloco = item.bloco;
                const apto = item.apto;
                const morador = `"${item.morador.replace(/"/g, '""')}"`;
                const descricao = `"${item.descricao.replace(/"/g, '""')}"`;
                const retiradoPor = `"${item.entreguePara.replace(/"/g, '""')}"`;
                return `${data},${bloco},${apto},${morador},${descricao},${retiradoPor}`;
            }).join('\n');

            const conteudoFinal = cabecalho + csvContent;
            const blob = new Blob([conteudoFinal], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "correspondencias_entregues.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Arquivo Excel (CSV) gerado com sucesso! Verifique a pasta de downloads.');
        }

        window.onload = init;

        window.addEventListener('beforeunload', () => db.salvar());
    </script>
</body>
</html>
